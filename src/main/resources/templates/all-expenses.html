<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>All Expenses - Spendly</title>
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/all-expenses.css}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <h2>Spendly</h2>
        <nav>
            <a href="/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="/expenses" class="active"><i class="fas fa-receipt"></i> All Expenses</a>
            <a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </aside>

    <main>
        <header class="page-header">
            <div class="header-content">
                <h1><i class="fas fa-receipt"></i> All Expenses</h1>
                <div class="header-stats">
                    <div class="stat-badge">
                        <span class="stat-label">Total Expenses</span>
                        <span class="stat-value" id="totalExpensesCount">0</span>
                    </div>
                    <div class="stat-badge">
                        <span class="stat-label">Total Amount</span>
                        <span class="stat-value" id="totalExpensesAmount">₱0.00</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Action Section -->
        <div class="action-section">
            <!-- Add Expense Form -->
            <div class="form-card">
                <div class="form-header">
                    <h3><i class="fas fa-plus-circle"></i> Add New Expense</h3>
                </div>
                <form id="addExpenseForm" class="form-grid">
                    <div class="form-group">
                        <input type="text" name="title" placeholder="Expense Title" required>
                        <i class="fas fa-tag form-icon"></i>
                    </div>
                    <div class="form-group">
                        <input type="number" step="0.01" name="amount" placeholder="Amount" required>
                        <i class="fas fa-peso-sign form-icon"></i>
                    </div>
                    <div class="form-group">
                        <input type="text" name="category" placeholder="Category" required>
                        <i class="fas fa-folder form-icon"></i>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-plus"></i> Add Expense
                    </button>
                </form>
            </div>

            <!-- Search and Filters -->
            <div class="search-section">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search expenses by title, category, or date..." onkeyup="filterTable()">
                </div>
                <div class="filter-options">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="recent">Recent</button>
                    <button class="filter-btn" data-filter="high">Highest</button>
                </div>
            </div>
        </div>

        <!-- Expenses Table -->
        <div class="table-section">
            <div class="table-header">
                <h3><i class="fas fa-list"></i> Expense Records</h3>
                <div class="table-actions">
                    <button class="action-btn" onclick="refreshTable()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="table-container">
                <table id="expensesTable">
                    <thead>
                    <tr>
                        <th>Title</th>
                        <th>Amount</th>
                        <th>Category</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Expense</h3>
            <span class="close">&times;</span>
        </div>
        <form id="editForm" method="post" class="modal-form">
            <div class="form-group">
                <input type="text" name="title" id="editTitle" placeholder="Expense Title" required>
                <i class="fas fa-tag form-icon"></i>
            </div>
            <div class="form-group">
                <input type="number" step="0.01" name="amount" id="editAmount" placeholder="Amount" required>
                <i class="fas fa-peso-sign form-icon"></i>
            </div>
            <div class="form-group">
                <input type="text" name="category" id="editCategory" placeholder="Category" required>
                <i class="fas fa-folder form-icon"></i>
            </div>
            <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                <button type="submit" class="save-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Ensure modal is hidden on page load
document.addEventListener('DOMContentLoaded', function() {
    var modal = document.getElementById("editModal");
    modal.style.display = "none";
});

var modal = document.getElementById("editModal");
var span = document.getElementsByClassName("close")[0];
var form = document.getElementById("editForm");
var titleInput = document.getElementById("editTitle");
var amountInput = document.getElementById("editAmount");
var categoryInput = document.getElementById("editCategory");

// Improved close functions
function closeModal() {
    modal.style.display = "none";
}

span.onclick = closeModal;

window.onclick = (event) => { 
    if(event.target == modal) {
        closeModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

function formatPeso(amount) {
    return '₱' + amount.toFixed(2);
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

function refreshTable() {
    $.get("/expenses/list", function(data){
        var html = "";
        var totalAmount = 0;
        
        // Sort by newest first
        data.sort((a,b) => new Date(b.date) - new Date(a.date));
        
        data.forEach(e => {
            totalAmount += e.amount;
            html += `<tr>
                <td class="expense-title">
                    <i class="fas fa-receipt"></i>
                    <span>${e.title}</span>
                </td>
                <td class="expense-amount">${formatPeso(e.amount)}</td>
                <td class="expense-category">
                    <span class="category-badge">${e.category}</span>
                </td>
                <td class="expense-date">${formatDate(e.date)}</td>
                <td class="action-buttons">
                    <button class="edit-btn" data-id="${e.id}" data-title="${e.title}" data-amount="${e.amount}" data-category="${e.category}">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="delete-btn" data-id="${e.id}">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            </tr>`;
        });
        
        $("#expensesTable tbody").html(html);
        $("#totalExpensesCount").text(data.length);
        $("#totalExpensesAmount").text(formatPeso(totalAmount));
        
        attachModalHandlers();
        attachDeleteHandlers();
        attachFilterHandlers();
    });
}

// Add expense
$("#addExpenseForm").submit(function(e){
    e.preventDefault();
    $.post("/expenses/add", $(this).serialize(), function(){
        $("#addExpenseForm")[0].reset();
        refreshTable();
        showNotification('Expense added successfully!', 'success');
    }).fail(function() {
        showNotification('Error adding expense. Please try again.', 'error');
    });
});

// Edit expense
function attachModalHandlers() {
    $(".edit-btn").click(function(){
        var id = $(this).data("id");
        titleInput.value = $(this).data("title");
        amountInput.value = $(this).data("amount");
        categoryInput.value = $(this).data("category");
        form.action = '/expenses/update/' + id;
        modal.style.display = "block";
    });
}

form.onsubmit = function(e){
    e.preventDefault();
    $.post(form.action, $(form).serialize(), function(){ 
        modal.style.display = "none"; 
        refreshTable();
        showNotification('Expense updated successfully!', 'success');
    }).fail(function() {
        showNotification('Error updating expense. Please try again.', 'error');
    });
}

// Delete expense
function attachDeleteHandlers() {
    $(".delete-btn").click(function(){
        var id = $(this).data("id");
        if(confirm('Are you sure you want to delete this expense?')) {
            $.post('/expenses/delete/' + id, function(){ 
                refreshTable();
                showNotification('Expense deleted successfully!', 'success');
            }).fail(function() {
                showNotification('Error deleting expense. Please try again.', 'error');
            });
        }
    });
}

// Filter functionality
function attachFilterHandlers() {
    $(".filter-btn").click(function() {
        $(".filter-btn").removeClass("active");
        $(this).addClass("active");
        
        const filter = $(this).data("filter");
        const rows = $("#expensesTable tbody tr");
        
        switch(filter) {
            case 'recent':
                // Already sorted by recent by default
                rows.show();
                break;
            case 'high':
                rows.sort((a, b) => {
                    const amountA = parseFloat($(a).find('.expense-amount').text().replace('₱', ''));
                    const amountB = parseFloat($(b).find('.expense-amount').text().replace('₱', ''));
                    return amountB - amountA;
                }).appendTo('#expensesTable tbody');
                break;
            default:
                rows.show();
        }
    });
}

// Search/filter
function filterTable() {
    const filter = $("#searchInput").val().toLowerCase();
    $("#expensesTable tbody tr").each(function(){
        $(this).toggle($(this).text().toLowerCase().indexOf(filter) > -1);
    });
}

// Notification system
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

refreshTable();
</script>
</body>
</html>